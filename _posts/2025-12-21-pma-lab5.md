---
layout: post
title:  Malware Samples - PMA Chapter 5
categories: malware
comments: true
excerpt: "Static analysis using IDA Pro" 
---
<p>
Chapter 4 was A Crash Course in x86 Disassembly and had no labs. One thing that CS 6747 covered heavily was x86 Assembly, so I was very comfortable with this topic. Still, I like to read different perspectives on something I'm interested in learning because it reinforces anything that may have been missed and may introduce some new information, which was the case here. In this chapter, I learned about instructions I had not heard of like ROR/ROL, REP, and IN. It also dove into details about MUL and DIV I was not aware of. Chapter 4 would be an excellent introduction to Assembly for anyone new to the subject, except that I still like to think of the stack as growing downward (it's just easier to visualize how everything fits together that way).
</p>
<p>
Chapter 5 is just an introduction to IDA Pro and all of the questions are based on one DLL. Even though I'm already familiar with this type of static analysis, all of my experience so far has been with Ghidra and this will help to make me a more well-rounded malware analyst. Unfortunately Hex-Rays does not have an archive of previous IDA Pro versions and the newest version was not compatible with Windows XP. This forced me to install a Windows 10 VM, which is some added work for the labs in this book, but will be useful for any malware analysis I want to do in the future.
</p>

<h2>Questions:</h2>
<ol>
<a href="#1-1"><li>What is the address of <b>DllMain</b>?</li></a>
<a href="#1-2"><li>Use the Imports window to browse to <b>gethostbyname</b>. Where is the import located?</li></a>
<a href="#1-3"><li>How many functions call <b>gethostbyname</b>?</li></a>
<a href="#1-4"><li>Focusing on the call to <b>gethostbyname</b> located at <b>0x10001757</b>, can you figure out which DNS request will be made?</li></a>
<a href="#1-5"><li>How many local variables has IDA Pro recognized for the subroutine at <b>0x10001656</b>?</li></a>
<a href="#1-6"><li>How many parameters has IDA Pro recognized for the subroutine at <b>0x10001656</b>?</li></a>
<a href="#1-7"><li>Use the Strings window to locate the string <b>\cmd.exe /c</b> in the disassembly. Where is it located?</li></a>
<a href="#1-8"><li>What is happening in the area of code that references <b>\cmd.exe /c</b>?</li></a>
<a href="#1-9"><li>In the same area, at <b>0x100101C8</b>, it looks like <b>dword_1008E5C4</b> is a global variable that helps decide which path to take. How does the malware set <b>dword_1008E5C4</b>?</li></a>
<a href="#1-10"><li>A few hundred lines into the subroutine at <b>0x1000FF58</b>, a series of comparisons use <b>memcmp</b> to compare strings. What happens if the string comparison to <b>robotwork</b> is successful?</li></a>
<a href="#1-11"><li>What does the export <b>PSLIST</b> do?</li></a>
<a href="#1-12"><li>Use the graph mode to graph to cross-references from <b>sub_10004E79</b>. Which API functions could be called by entering this function? Based on the API functions alone, what could you rename this function?</li></a>
<a href="#1-13"><li>How many Windows API functions does <b>DllMain</b> call directly? How many at a depth of 2?</li></a>
<a href="#1-14"><li>At <b>0x10001358</b>, there is a call to <b>Sleep</b>. Looking backward through the code, how long will the program sleep if this code executes?</li></a>
<a href="#1-15"><li>At <b>0x10001701</b> is a call to <b>socket</b>. What are the three parameters?</li></a>
<a href="#1-16"><li>Using the MSDN page for <b>socket</b> and the named symbolic constants functionality in IDA Pro, can you make the parameters more meaningful? What are the parameters after you apply changes?</li></a>
<a href="#1-17"><li>Search for usage of the <b>in</b> instruction (opcode <b>0xED</b>). This instruction is used with a magic string <b>VMXh</b> to perform VMware detection. Is that in use in this malware? Using the cross-references to the function that executes the <b>in</b> instruction, is there further evidence of VMware detection?</li></a>
<a href="#1-18"><li>Jump your cursor to <b>0x1001D988</b>. What do you find?</li></a>
<a href="#1-19"><li>If you have the IDA Python plug-in installed, run <b>Lab05-01.py</b>, an IDA Pro Python script provided with the malware for this book. What happens after you run the script? (Make sure the cursor is at <b>0x1001D988</b>)</li></a>
<a href="#1-20"><li>With the cursor in the same location, how do you turn this data into a single ASCII string?</li></a>
<a href="#1-21"><li>Open the script with a text editor. How does it work?</li></a>
</ol>

<div id="1-1" class="section-link">
<h2>What is the address of <b>DllMain</b>?</h2>
<p>
DllMain can be located by looking through the Functions window on the left side of the display. Double-clicking brings us to that function, which is located at <b>0x1000D02E</b>:<br>
<img src="/images/lab5/dllmain.png">
</p>
</div>

<div id="1-2" class="section-link">
<h2>Use the Imports window to browse to <b>gethostbyname</b>. Where is the import located?</h2>
<p>
Clicking on the Imports tab and scrolling down to <b>gethostbyname</b> shows that function at <b>0x100163CC</b>:<br>
<img src="/images/lab5/gethostbyname.png">
</p>
</div>

<div id="1-3" class="section-link">
<h2>How many functions call <b>gethostbyname</b>?</h2>
<p>
Double-clicking on the function in the imports window jumps to <b>0x100163CC</b> in the <b>.idata</b> section. Clicking on function name and then pressing X brings up the cross-references window. Each call is counted twice (in the Type column <b>p</b> is a "near", or intrasegment, call and <b>r</b> is a reference), so the list of 18 items is actually 9 calls. The Address column shows the address of each function where <b>gethostbyname</b> was called and the offset of the call from the start of that function. The Address column shows 5 different functions (note that functions <b>sub_1001074</b> and <b>sub_1001365</b> have multiple offsets):<br>
<img src="/images/lab5/gethostbyname-calls.png">
</p>
</div>

<div id="1-4" class="section-link">
<h2>Focusing on the call to <b>gethostbyname</b> located at <b>0x10001757</b>, can you figure out which DNS request will be made?</h2>
<p>
The previous jump to that function showed that it takes one argument. The last thing pushed to the stack before the call was made at <b>0x10001757</b> was the data stored at <b>0x10019040</b>, which was <b>pics.practicalmalwareanalysis.com</b>:<br>
<img src="/images/lab5/url.png">
</p>
</div>

<div id="1-5" class="section-link">
<h2>How many local variables has IDA Pro recognized for the subroutine at <b>0x10001656</b>?</h2>
<p>
Local variables are stored at a negative offset from EBP. Jumping to that address shows 23 items matching that definition:<br>
<img src="/images/lab5/vars.png">
</p>
</div>

<div id="1-6" class="section-link">
<h2>How many parameters has IDA Pro recognized for the subroutine at <b>0x10001656</b>?</h2>
<p>
Only one variable from the previous step is located above EBP, which means that <b>lpThreadParameter</b> the only argument to this function.
</p>
</div>

<div id="1-7" class="section-link">
<h2>Use the Strings window to locate the string <b>\cmd.exe /c</b> in the disassembly. Where is it located?</h2>
<p>
This string is located at <b>0x10095B34</b> in a section called <b>xdoors_d</b>, which contains many other strings indicating that this is a backdoor:<br>
<img src="/images/lab5/string.png">
</p>
</div>

<div id="1-8" class="section-link">
<h2>What is happening in the area of code that references <b>\cmd.exe /c</b>?</h2>
<p>
This string is referenced at <b>0x100101D0</b>, in the <b>.text</b> section. After being pushed to the stack, it is appended to a local variable on the stack IDA has named <b>Destination</b> using <b>strcat</b>:<br>
<img src="/images/lab5/string-ref-1.png">
</p>
<p>
The string is used to create a new instance of cmd.exe and scrolling back through this function, it appears that this instance is created for usage through the backdoor:<br>
<img src="/images/lab5/string-ref-2.png">
</p>
</div>

<div id="1-9" class="section-link">
<h2>In the same area, at <b>0x100101C8</b>, it looks like <b>dword_1008E5C4</b> is a global variable that helps decide which path to take. How does the malware set <b>dword_1008E5C4</b>?</h2>
<p>
Checking cross-references, there is only one location where <b>dword_1008E5C4</b> is defined:<br>
<img src="/images/lab5/def.png">
</p>
<p>
At that location, a user-defined function is called and the return value from that function is placed into <b>dword_1008E5C4</b>:<br>
<img src="/images/lab5/def2.png">
</p>
<p>
The purpose of that function is the retrieval of OS version information:<br>
<img src="/images/lab5/func.png">
</p>
<p>
The value written to EAX (AL) at the end of that function, which is then used in the comparison referenced in the question, is the result of a comparison of <b>VersionInformation.dwPlatformId</b> with <b>2</b>, which according to Microsoft's documentation indicates that it is a 32-bit Windows system:<br>
<img src="/images/lab5/platformid.png">
</p>
<p>
Going back to the original question, the result returned from <b>VersionInformation.dwPlatformId</b> dictates whether the string <b>cmd.exe</b> or <b>command.exe</b> will be used:<br>
<img src="/images/lab5/jumps.png">
</p>
</div>

<div id="1-10" class="section-link">
<h2>A few hundred lines into the subroutine at <b>0x1000FF58</b>, a series of comparisons use <b>memcmp</b> to compare strings. What happens if the string comparison to <b>robotwork</b> is successful?</h2>
<p>
The string comparison is performed using <b>memcmp</b>, which will return 0 if the strings are identical, meaning if this comparison is successful, the following jump will not be taken and a user-defined function will be called:<br>
<img src="/images/lab5/robotwork-1.png">
</p>
<p>
The purpose of this function is the retrieval of a <b>Robot_WorkTime</b> value from the registry, which I am assuming is the total uptime of this backdoor or some similar measurement:<br>
<img src="/images/lab5/robotwork-2.png">
</p>
</div>

<div id="1-11" class="section-link">
<h2>What does the export <b>PSLIST</b> do?</h2>
<p>
Double-clicking on <b>PSLIST</b> from the Exports window jumps straight to this function, which takes 3 ints and a string as arguments:<br>
<img src="/images/lab5/pslist-1.png">
</p>
<p>
<b>strlen</b> is performed on the string argument and if successful, calls a user-defined function which returns process IDs and names depending on the arguments supplied:<br>
<img src="/images/lab5/pslist-2.png">
</p>
</div>

<div id="1-12" class="section-link">
<h2>Use the graph mode to graph to cross-references from <b>sub_10004E79</b>. Which API functions could be called by entering this function? Based on the API functions alone, what could you rename this function?</h2>
<p>
Based on the calls to <b>GetSystemDefaultLangID</b> and <b>send</b>, it appears to send the default language of the system back to the C2. This sounds a lot like actual functionality implemented by ransomware groups like REvil who check if the user is from a Russian-speaking country before performing any malicious activity. A good name for this function would be <b>checkIfRussian</b>:<br>
<img src="/images/lab5/checkifrussian.png">
</p>
</div>

<div id="1-13" class="section-link">
<h2>How many Windows API functions does <b>DllMain</b> call directly? How many at a depth of 2?</h2>
<p>
Viewing a custom graph of cross-references from DllMain shows only 4 Windows API calls at a recursion depth of 1:<br>
<img src="/images/lab5/dllmain-1.png">
</p>
<p>
Increasing the depth to 2 adds a signifcant number of calls; I counted 33:<br>
<img src="/images/lab5/dllmain-2.png">
</p>
</div>

<div id="1-14" class="section-link">
<h2>At <b>0x10001358</b>, there is a call to <b>Sleep</b>. Looking backward through the code, how long will the program sleep if this code executes?</h2>
<p>
First, the string "30" is converted to an integer and then multipled by 0x3E8, which is 1000 in decimal, before calling Sleep on that value. This would result in a sleep time of 30,000 ms (30 seconds):<br>
<img src="/images/lab5/sleep.png">
</p>
</div>

<div id="1-15" class="section-link">
<h2>At <b>0x10001701</b> is a call to <b>socket</b>. What are the three parameters?</h2>
<p>
The three parameters pushed to the stack prior to this call are 2, 1, and 6:<br>
<img src="/images/lab5/socket-1.png">
</p>
</div>

<div id="1-16" class="section-link">
<h2>Using the MSDN page for <b>socket</b> and the named symbolic constants functionality in IDA Pro, can you make the parameters more meaningful? What are the parameters after you apply changes?</h2>
<p>
IDA did a good job of identifying the parameters for this call:<br>
<img src="/images/lab5/socket-2.png">
</p>
<p>
The 2 passed to the <b>af</b> parameter indicates IPv4:<br>
<img src="/images/lab5/socket-3.png">
</p>
<p>
The 1 passed to the <b>type</b> parameter makes this a TCP socket:<br>
<img src="/images/lab5/socket-4.png">
</p>
<p>
The 6 passed to the <b>protocol</b> parameter sets the protocol to TCP as well:<br>
<img src="/images/lab5/socket-5.png">
</p>
</div>

<div id="1-17" class="section-link">
<h2>Search for usage of the <b>in</b> instruction (opcode <b>0xED</b>). This instruction is used with a magic string <b>VMXh</b> to perform VMware detection. Is that in use in this malware? Using the cross-references to the function that executes the <b>in</b> instruction, is there further evidence of VMware detection?</h2>
<p>
Searching for "in" only returns one location where this is used as an instruction:<br>
<img src="/images/lab5/in-1.png">
</p>
<p>
This is the series of instructions found at that location:<br>
<img src="/images/lab5/in-2.png">
</p>
<p>
I did not feel that the book explained this instruction adequately and had to do some research to gain a better understanding. Normally, the <b>IN</b> instruction reads data from an I/O port into a register. In VMware, there is a virtual port <b>VX</b> that if read using <b>IN</b> while the value of EAX is <b>VMXh</b>, VMware will trap the instruction and return <b>VMXh</b> to a register and version info, etc. to other registers. This behavior does not appear to be well-documented and would be interesting to research later. Here, the <b>VMXh</b> and <b>VX</b> strings can be seen being moved into EAX and EDX:<br>
<img src="/images/lab5/in-3.png"><br>
<img src="/images/lab5/in-4.png"><br>
If the <b>IN</b> instruction detects VMware, it appears that <b>VMXh</b> is returned to EBX, where it is compared.
</p>
<p>
There are three references to the function containing this series of instructions, all of which contain the same string hinting at VM detection:<br>
<img src="/images/lab5/in-5.png">
</p>
</div>

<div id="1-18" class="section-link">
<h2>Jump your cursor to <b>0x1001D988</b>. What do you find?</h2>
<p>
This points to the .data section and appears to contain an obfuscated string:<br>
<img src="/images/lab5/obf-string.png">
</p>
</div>

<div id="1-19" class="section-link">
<h2>If you have the IDA Python plug-in installed, run <b>Lab05-01.py</b>, an IDA Pro Python script provided with the malware for this book. What happens after you run the script? (Make sure the cursor is at <b>0x1001D988</b>)</h2>
<p>
Unfortunately, Hex-Rays removed Python support from free versions of IDA Pro. I had to come up with my own workaround for decoding this string.
</p>
</div>

<div id="1-20" class="section-link">
<h2>With the cursor in the same location, how do you turn this data into a single ASCII string?</h2>
<p>
This was another difficulty I had with this string. Right-clicking and converting to string encloses each character in single quotes. This must have worked differently at the time the book was written. The most reliable way I found was going to the Hex Dump view and copying the raw bytes:<br>
<img src="/images/lab5/bytes.png">
</p>
</div>

<div id="1-21" class="section-link">
<h2>Open the script with a text editor. How does it work?</h2>
<p>
The script works by iterating over the 0x50 bytes of the obfuscated string and XORing each with 0x55:<br>
<img src="/images/lab5/script.png">
</p>
<p>
I ended up copying the raw bytes from the Hex Dump view and pasting them into Cyber Chef. Using the From Hex and XOR operations with a key of 0x55 reveals the string:<br>
<img src="/images/lab5/cyber-chef.png">
</p>
</div>
<br>
<br>
<div>
<h2>Conclusion</h2>
<p>
This was a great refresher of static analysis using a disassembler. Many of IDA's features are easier to use than Ghidra, but there are some areas where it struggles. I was disappointed that Python is no longer supported in the free versions and I look forward to the day that I am doing this type of work full time and have the opportunity to use the paid version!
</p>
</div>