---
layout: post
title:  Malware Samples - PMA Chapter 1
categories: malware
comments: true
excerpt: "Four malware samples from the first chapter of Practical Malware Analysis" 
---
<p>
The first chapter in Practical Malware Analysis discusses the basics of static/dynamic analysis including the Portable Executable (PE) format, static/dynamic/runtime linking (DLLs), and packing/obfuscation. This chapter introduced some basic tools for static analysis of PE files such as PEView, Resource Hacker, and Dependency Walker. Four malware samples are included to reinforce what was taught in the chapter and gain some familiarity with the tools. 
</p>

<h2>Samples:</h2>
<ol>
<a href="#sample-1"><li>Malware Sample 1</li></a>
<a href="#sample-2"><li>Malware Sample 2</li></a>
<a href="#sample-3"><li>Malware Sample 3</li></a>
<a href="#sample-4"><li>Malware Sample 4</li></a>
</ol>

<div id="sample-1" class="section-link">
<h2>Malware Sample 1</h2>
<p>
The first malware sample consists of one executable and one DLL. We are asked several questions regarding PE file contents to become familiar with their structure and the PEView tool.
</p>
</div>

<h2>Questions:</h2>
<ol>
<a href="#1-1"><li>Upload the sample to Virus Total.</li></a>
<a href="#1-2"><li>When were these files compiled?</li></a>
<a href="#1-3"><li>Are there any indications that either of these files are packed or obfuscated?</li></a>
<a href="#1-4"><li>Do any imports hint at what this malware does?</li></a>
<a href="#1-5"><li>Are there any other files or host-based indicators you could look for on infected systems?</li></a>
<a href="#1-6"><li>What network-based indicators could be used to find this malware on infected machines?</li></a>
<a href="#1-7"><li>What would you guess is the purpose of these files?</li></a>
</ol>

<div id="1-1" class="section-link">
<h2>Upload the sample to Virus Total.</h2>
<p>
Unfortunately none of the samples can be uploaded to Virus total using the recommended Windows XP VM. Even the version of the website designed for older browsers still includes a Captcha, making it incompatible.<br>
<img src="/images/lab1/virus-total.png">
</p>
</div>

<div id="1-2" class="section-link">
<h2>When were these files compiled?</h2>
<p>
Here I get to use PEView for the first time to inspect PE headers. Looking at <b>IMAGE_NT_HEADERS/IMAGE_FILE_HEADER</b>, we can see that both of these files were compiled on 12/19/2010.<br>
<img src="/images/lab1/compile-time.png">
</p>
</div>

<div id="1-3" class="section-link">
<h2>Are there any indications that either of these files are packed or obfuscated?</h2>
<p>
Looking at the <b>IMAGE_SECTION_HEADER</b> data for all of the sections, there is nothing that indicates packed files. If these were packed, the virtual size would appear much larger than the raw data size because of the unpacking process.<br>
<img src="/images/lab1/size.png"><br>
</p>
<p>
However, there is something interesting in the .rdata <b>IMPORT</b> table from the DLL file. Ten functions are imported from WS2_32.dll, but they are imported by ordinal instead of name, which disguises their purpose. Opening C:\Windows\system32\ws2_32.dll in PEView and looking at the <b>EXPORT</b> table in the .text section allows a cross-reference of the ordinal values and their name. This DLL includes functions for network communication and a few can be seen here:<br>
<img src="/images/lab1/ordinal.png"><br>
</p>
</div>

<div id="1-4" class="section-link">
<h2>Do any imports hint at what this malware does?</h2>
<p>
Looking at <b>IMPORT</b> table from the <b>.rdata</b> section for the executable shows that functions are imported from msvcrt.dll and kernel32.dll. The Visual C-runtime (msvcrt.dll) functions all look pretty standard, but there are some functions from kernel32.dll which show file manipulation functions:<br>
<img src="/images/lab1/functions-1.png">
</p>
<p>
These functions, combined with the obfuscated functions from the DLL identified earlier indicate that this sample has the ability for network communication and file manipulation.
</p>
</div>

<div id="1-5" class="section-link">
<h2>Are there any other files or host-based indicators you could look for on infected systems?</h2>
<p>
In the .data section of the executable, there is a string "kerne132.dll", with the number one in the name meant to look like a lowercase <b>L</b>:<br>
<img src="/images/lab1/kerne132.png"><br>
<b>WARNING_THIS_WILL_DESTROY_YOUR_MACHINE</b> might be another good indicator &#128514;
</p>
<p>
This filename would be a good indicator for not only this malware, but possibly others as well.
</p>

<div id="1-6" class="section-link">
<h2>What network-based indicators could be used to find this malware on infected machines?</h2>
<p>
There is another suspicious string in the .data section of the DLL which looks like an IP address:<br>
<img src="/images/lab1/ip.png">
</p>
<p>
Traffic to/from the IP address <b>127.26.152.13</b> would be a strong network-based indicator of this malware.
</p>

<div id="1-7" class="section-link">
<h2>What would you guess is the purpose of these files?</h2>
<p>
The executable imports functions for creating, finding, and copying files. This is where the kerne132.dll and system32 path strings are located, leading me to believe that the purpose of this file is to create the kernel32.dll lookalike and copy it to C:\Windows\system32. The included DLL (not kerne132) imports functions for process manipulation and networking communication.
</p>
<p>
The fact that the executable never imports the DLL and neither file imports the newly-created kerne132.dll leads me to believe that kerne132.dll will import the process manipulation and networking functions from the included DLL. All of these functions combined could be used for a backdoor.
</p>
</div>

<div id="sample-2" class="section-link">
<h2>Malware Sample 2</h2>
<p>
This sample includes just one executable, which appears to be packed.
</p>
</div>

<h2>Questions:</h2>
<ol>
<a href="#2-1"><li>Upload the sample to Virus Total.</li></a>
<a href="#2-2"><li>Are there any indications that this file is packed or obfuscated?</li></a>
<a href="#2-3"><li>Do any imports hint at this program's functionality?</li></a>
<a href="#2-4"><li>What host- or network-based indicators could be used to identify this malware on infected machines?</li></a>
</ol>

<div id="2-1" class="section-link">
<h2>Upload the sample to Virus Total.</h2>
<p>
As shown <a href="#1-1">here</a>, this is no longer possible on Windows XP.
</p>
</div>

<div id="2-2" class="section-link">
<h2>Are there any indications that this file is packed or obfuscated?</h2>
<p>
Instead of the usual names like .text, .data, etc., sections have been renamed to UPX0, UPX1, and UPX2, indicating that this sample was packed using UPX. Sections with a virtual size much larger than the raw data size also indicate packing.<br>
<img src="/images/lab1/obfuscated.png">
</p>
</div>

<div id="2-3" class="section-link">
<h2>Do any imports hint at this program's functionality?</h2>
<p>
Functions are imported for virtual memory allocation, service creation, and internet connectivity.<br>
<img src="/images/lab1/imports-2.png">
</p>
</div>

<div id="2-4" class="section-link">
<h2>What host- or network-based indicators could be used to identify this malware on infected machines?</h2>
<p>
Because this binary is packed, strings in the .data section are corrupted and cannot be used for identification:<br>
<img src="/images/lab1/partial-url.png">
</p>
<p>
To unpack this file, I was able to download UPX from GitHub and fortunately it still works on XP!<br>
<img src="/images/lab1/upx.png">
</p>
<p>
With the binary unpacked, plaintext strings are now visible:<br>
<img src="/images/lab1/unpacked.png">
</p>
<p>
The strings that have been revealed appear to be arguments for the imported functions such as CreateServiceA and InternetOpenA. Indicators used to identify the presence of this sample would be processes named <b>Malservice</b> or network traffic to/from <b>http://malwareanalysisbook.com</b>.
</p>
</div>

<div id="sample-3" class="section-link">
<h2>Malware Sample 3</h2>
<p>
This sample is another packed executable.
</p>
</div>

<h2>Questions:</h2>
<ol>
<a href="#3-1"><li>Upload the sample to Virus Total.</li></a>
<a href="#3-2"><li>Are there any indications that this file is packed or obfuscated?</li></a>
<a href="#3-3"><li>Do any imports hint at this program's functionality?</li></a>
<a href="#3-4"><li>What host- or network-based indicators could be used to identify this malware on infected machines?</li></a>
</ol>

<div id="3-1" class="section-link">
<h2>Upload the sample to Virus Total.</h2>
<p>
N/A
</p>
</div>

<div id="3-2" class="section-link">
<h2>Are there any indications that this file is packed or obfuscated?</h2>
<p>
This sample also has sections with virtual sizes much larger than the raw data size. However, on this sample the section names are missing entirely and the packing method is unknown:<br>
<img src="/images/lab1/missing.png">
</p>
<p>
Analyzing this sample with PEiD shows that it is packed using FSG:<br>
<img src="/images/lab1/fsg.png">
</p>
</div>

<div id="3-3" class="section-link">
<h2>Do any imports hint at this program's functionality?</h2>
<p>
This sample also does not list any imports when viewed in PEView. The only indication of any of its functionality are a DLL name and a couple functions, but not enough to make any sense of:<br>
<img src="/images/lab1/strings.png">
</p>
</div>

<div id="3-4" class="section-link">
<h2>What host- or network-based indicators could be used to identify this malware on infected machines?</h2>
<p>
Unfortunately this sample is too heavily-obfuscated to gather any useful indicators and cannot be directly unpacked using the methods learned so far. Referencing the lab solutions for this sample confirms that this was the expected result and that this sample will be re-visited in a later chapter using more advanced analysis techniques.
</p>
</div>

<div id="sample-4" class="section-link">
<h2>Malware Sample 4</h2>
<p>
This sample is an executable which appears to have more functionality than any of the previous samples.
</p>
</div>

<h2>Questions:</h2>
<ol>
<a href="#4-1"><li>Upload the sample to Virus Total.</li></a>
<a href="#4-2"><li>Are there any indications that this file is packed or obfuscated?</li></a>
<a href="#4-3"><li>When was this program compiled?</li></a>
<a href="#4-4"><li>Do any imports hint at this program's functionality?</li></a>
<a href="#4-5"><li>What host- or network-based indicators could be used to identify this malware on infected machines?</li></a>
<a href="#4-6"><li>This file has one resource in the resource section. Use Resource Hacker to examine that resource, and then use it to extract the resource. What can you learn from the resource?</li></a>
</ol>

<div id="4-1" class="section-link">
<h2>Upload the sample to Virus Total.</h2>
<p>
N/A
</p>
</div>

<div id="4-2" class="section-link">
<h2>Are there any indications that this file is packed or obfuscated?</h2>
<p>
The naming of sections appears normal with no indication of packing when comparing virtual and raw data sizes. There is also no evidence of obfuscation.
</p>
</div>

<div id="4-3" class="section-link">
<h2>When was this program compiled?</h2>
<p>
This sample was compiled on 8/30/2019:
<img src="/images/lab1/compile-time-2.png">
</p>
</div>

<div id="4-4" class="section-link">
<h2>Do any imports hint at this program's functionality?</h2>
<p>
Many of the imports are focused on process/resource/file manipulation. Of particular interest is the <b>AdjustTokenPrivileges</b> function imported from <b>ADVAPI32.dll</b>, which may indicate privilege escalation:<br>
<img src="/images/lab1/imports-4.png">
</p>
</div>

<div id="4-5" class="section-link">
<h2>What host- or network-based indicators could be used to identify this malware on infected machines?</h2>
<p>
Looking at the <b>.data</b> section reveals many concerning targets for the imported functions:<br>
<img src="/images/lab1/targets.png">
<ul>
<li><b>winlogon.exe</b> - The legitimate <b>winlogon.exe</b> is a system process responsible for user authentication. &lt;not real&gt; may be a clue from the authors of the lab that this is a duplicate created by the malware.</li>
<li><b>SeDebugPrivilege</b> - This can be used to duplicate high privilege tokens, which would most likely be used for the process created from the duplicate <b>winlogon.exe</b>. This confirms earlier suspicions of privilege escalation.</li>
<li><b>sfc_os.dll</b> - This library is responsible for verifying the integrity of Windows system files. Manipulation of this DLL would be necessary for the type malicious activity assumed so far.</li>
<li><b>wupdmgr.exe</b> - This is the Windows update manager and could also be a target for the aforementioned functionality.</li>
</ul>
The spoofing or manipulation of these critical Windows services would be good indicators of an infection by this malware sample.
</p>
</div>

<div id="4-6" class="section-link">
<h2>This file has one resource in the resource section. Use Resource Hacker to examine that resource, and then use it to extract the resource. What can you learn from the resource?</h2>
<p>
Looking at this resource, it appears to be a binary which was embedded:<br>
<img src="/images/lab1/resource-1.png">
</p>
<p>
Because of this, I chose to save it in that format:<br>
<img src="/images/lab1/resource-2.png">
</p>
<p>
And then open this new binary in PEView, where it can be seen that it downloads and executes a file:<br>
<img src="/images/lab1/embedded-1.png">
</p>
<p>
Which is <b>http://practicalmalwareanalysis.com/updater.exe</b>:<br>
<img src="/images/lab1/embedded-2.png">
</p>
</div>
<div>
<h2>Conclusion</h2>
<p>
And that's the end of the Chapter 1 labs! This was a great overview of PE files and their structure, which was something I had read about in my Malware Analysis course, but getting this hands-on practice really improved my understanding.
</p>
</div>