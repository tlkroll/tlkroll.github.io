---
layout: post
title:  Malware Samples - PMA Chapter 6
categories: malware
comments: true
excerpt: "Identifying C constructs in Assembly" 
---
<p>
These labs build on the basic Assembly exercises from Chapter 6 and demonstrate how to identify C constructs such as loops, conditionals, switch statements, etc.
</p>

<h2>Samples:</h2>
<ol>
<a href="#sample-1"><li>Malware Sample 1</li></a>
<a href="#sample-2"><li>Malware Sample 2</li></a>
<a href="#sample-3"><li>Malware Sample 3</li></a>
<a href="#sample-4"><li>Malware Sample 4</li></a>
</ol>

<div id="sample-1" class="section-link">
<h2>Malware Sample 1</h2>
<p>
This is a small sample with very basic functionality.
</p>
</div>

<h2>Questions:</h2>
<ol>
<a href="#1-1"><li>What is the major code construct found in the only subroutine called by <b>main</b>?</li></a>
<a href="#1-2"><li>What is the subroutine located at <b>0x40105f</b>?</li></a>
<a href="#1-3"><li>What is the purpose of this program?</li></a>
</ol>

<div id="1-1" class="section-link">
<h2>What is the major code construct found in the only subroutine called by <b>main</b>?</h2>
<p>
This question was deceptively simple and caused me to overthink it a bit, but the construct being referred to is a simple conditional. The result from <b>InternetGetConnectedState</b> is returned in EAX. That result is moved into <b>var_4</b> and compared against 0. If the result is 0 (not connected), execution jumps to <b>0x40102b</b>:<br>
<img src="/images/lab6/conditional.png">
</p>
</div>

<div id="1-2" class="section-link">
<h2>What is the subroutine located at <b>0x40105f</b>?</h2>
<p>
This one was a bit tricker. Quickly looking over the function itself does not reveal much:<br>
<img src="/images/lab6/printf-1.png">
</p>
<p>
Checking cross-references to see where this function is called makes it a little more obvious:<br>
<img src="/images/lab6/printf-2.png"><br>
This is just the <b>printf</b> function! Apparently IDA does not always recognize these calls automatically.
</p>
</div>

<div id="1-3" class="section-link">
<h2>What is the purpose of this program?</h2>
<p>
This is just a simple program that checks whether the host has an active internet connection and prints the results to the console.
</p>
</div>

<div id="sample-2" class="section-link">
<h2>Malware Sample 2</h2>
<p>
This sample builds on the first and expands the functionality slightly.
</p>
</div>

<h2>Questions:</h2>
<ol>
<a href="#2-1"><li>What operation does the first subroutine called by <b>main</b> perform?</li></a>
<a href="#2-2"><li>What is the subroutine located at <b>0x40117f</b>?</li></a>
<a href="#2-3"><li>What does the second subroutine called by <b>main</b> do?</li></a>
<a href="#2-4"><li>What type of code construct is used in this subroutine?</li></a>
<a href="#2-5"><li>Are there any network-based indicators for this program?</li></a>
<a href="#2-6"><li>What is the purpose of this malware?</li></a>
</ol>

<div id="2-1" class="section-link">
<h2>What operation does the first subroutine called by <b>main</b> perform?</h2>
<p>
This is the same function from the previous sample used to determine whether the host is connected to the internet.
</p>
</div>

<div id="2-2" class="section-link">
<h2>What is the subroutine located at <b>0x40117f</b>?</h2>
<p>
As with the previous sample, this is a call to <b>printf</b> that IDA did not automatically identify:<br>
<img src="/images/lab6/printf-3.png">
</p>
</div>

<div id="2-3" class="section-link">
<h2>What does the second subroutine called by <b>main</b> do?</h2>
<p>
First, this function connects to a URL:<br>
<img src="/images/lab6/getcommand-1.png">
</p>
<p>
Then the contents of the file <b>cc.htm</b> are read:<br>
<img src="/images/lab6/getcommand-2.png">
</p>
<p>
And finally, the data that has been read is checked that it begins with the <b>&lt;!--</b> string. It appears that the command being read is hidden within an HTML comment:<br>
<img src="/images/lab6/getcommand-3.png">
</p>
</div>

<div id="2-4" class="section-link">
<h2>What type of code construct is used in this subroutine?</h2>
<p>
The code construct used here is the character array (string) read from <b>cc.htm</b>.
</p>
</div>

<div id="2-5" class="section-link">
<h2>Are there any network-based indicators for this program?</h2>
<p>
The first indicator is the User Agent specified in the connection request, which is unusual:<br>
<img src="/images/lab6/user-agent.png">
</p>
<p>
The second indicator is the <b>www.practicalmalwareanalysis.com/cc.htm</b> URL that commands are read from.
</p>
</div>

<div id="2-6" class="section-link">
<h2>What is the purpose of this malware?</h2>
<p>
This malware checks for an internet connection and if successful reads a command from an HTML comment hosted on a malicious website. This sample does not perform any functions with the command, but simply checks that a valid command is present and prints it to the console:<br>
<img src="/images/lab6/print-command.png">
</p>
</div>

<div id="sample-3" class="section-link">
<h2>Malware Sample 3</h2>
<p>
Again, this sample builds on the previous one and adds a switch statement for processing the command received. 
</p>
</div>

<h2>Questions:</h2>
<ol>
<a href="#3-1"><li>Compare the calls in <b>main</b> to Lab 6-2's <b>main</b> method. What is the new function called from <b>main</b>?</li></a>
<a href="#3-2"><li>What parameters does this new function take?</li></a>
<a href="#3-3"><li>What major code construct does this function contain?</li></a>
<a href="#3-4"><li>What can this function do?</li></a>
<a href="#3-5"><li>Are there any host-based indicators for this malware?</li></a>
<a href="#3-6"><li>What is the purpose of this malware?</li></a>
</ol>

<div id="3-1" class="section-link">
<h2>Compare the calls in <b>main</b> to Lab 6-2's <b>main</b> method. What is the new function called from <b>main</b>?</h2>
<p>
After a command is successfully received from the malicious website, a call to a new function at <b>0x401130</b> has been added:<br>
<img src="/images/lab6/switch-1.png">
</p>
</div>

<div id="3-2" class="section-link">
<h2>What parameters does this new function take?</h2>
<p>
Before being called, the parsed command and an argv value that IDA has named <b>lpExistingFileName</b> are pushed to the stack:<br>
<img src="/images/lab6/switch-2.png"><br>
Note that if this sample were run with no flags, argv would just be the name of the current program.
</p>
Inside the function, IDA names these parameters <b>arg_0</b> (command) and <b>lpExistingFileName</b> (filename of this sample):<br>
<img src="/images/lab6/switch-3.png">
</div>

<div id="3-3" class="section-link">
<h2>What major code construct does this function contain?</h2>
<p>
This function uses the command from the previous function to select a case from a switch statement:<br>
<img src="/images/lab6/switch-4.png">
</p>
</div>

<div id="3-4" class="section-link">
<h2>What can this function do?</h2>
<p>
There are 5 cases which can be chosen. The first case creates the directory <b>C:\Temp</b>:<br>
<img src="/images/lab6/case-1.png">
</p>
<p>
The second case creates a copy of the current program at <b>C:\Temp\cc.exe</b>:<br>
<img src="/images/lab6/case-2.png">
</p>
<p>
The third case deletes the <b>C:\Temp\cc.exe</b> copy:<br>
<img src="/images/lab6/case-3.png">
</p>
<p>
The fourth case creates a registry key that will run the new malware copy at <b>C:\Temp\cc.exe</b> on startup. This key has the value name <b>Malware</b> &#128514;:<br>
<img src="/images/lab6/case-4.png">
</p>
<p>
The fifth case simply sleeps for 100 seconds:<br>
<img src="/images/lab6/case-5.png">
</p>
</div>

<div id="3-5" class="section-link">
<h2>Are there any host-based indicators for this malware?</h2>
<p>
Host-based indicators would be the presence of <b>cc.exe</b> and the <b>Malware</b> registry key.
</p>
</div>

<div id="3-6" class="section-link">
<h2>What is the purpose of this malware?</h2>
<p>
The purpose of this malware is to retrieve a command from a malicious webpage which tells the malware to copy itself to a new directory, delete the copied version, create a registry key that will run the new copy at startup, or sleep for 100 seconds.
</p>
</div>

<div id="sample-4" class="section-link">
<h2>Malware Sample 4</h2>
<p>
The final form of this malware sample.
</p>
</div>

<h2>Questions:</h2>
<ol>
<a href="#4-1"><li>What is the difference between the calls made from the <b>main</b> method in Labs 6-3 and 6-4?</li></a>
<a href="#4-2"><li>What new code construct has been added to <b>main</b>?</li></a>
<a href="#4-3"><li>What is the difference between this lab's parse HTML function and those of previous labs?</li></a>
<a href="#4-4"><li>How long will this program run?</li></a>
<a href="#4-5"><li>Are there any new network-based indicators for this malware?</li></a>
<a href="#4-6"><li>What is the purpose of this malware?</li></a>
</ol>

<div id="4-1" class="section-link">
<h2>What is the difference between the calls made from the <b>main</b> method in Labs 6-3 and 6-4?</h2>
<p>
This sample adds a backward jump after the call to <b>Sleep</b>:<br>
<img src="/images/lab6/loop-1.png">
</p>
</div>

<div id="4-2" class="section-link">
<h2>What new code construct has been added to <b>main</b>?</h2>
<p>
The code construct that has been added is a <b>for</b> loop. First, the counter is initialized to <b>0</b>, then it is incremented by <b>1</b> for each iteration, and the loop is broken after <b>0x5a0</b>, or <b>1,440</b> iterations:<br>
<img src="/images/lab6/loop-2.png"><br>
Following the jump arrows at the left it can be seen where the counter initialization is jumped to after a successful internet connection test <b>[1]</b>. After initialization, the counter increment is jumped over for the first iteration <b>[2]</b>. After the rest of the function is completed, a jump is taken back to the counter increment and test <b>[3]</b>:<br>
</p>
</div>

<div id="4-3" class="section-link">
<h2>What is the difference between this lab's parse HTML function and those of previous labs?</h2>
<p>
In this sample, the value of the loop counter is pushed to the stack before making the request:<br>
<img src="/images/lab6/counter-1.png">
</p>
<p>
The counter value is then appended to the User Agent string:<br>
<img src="/images/lab6/counter-2.png">
</p>
</div>

<div id="4-4" class="section-link">
<h2>How long will this program run?</h2>
<p>
In this sample, the value passed to the <b>Sleep</b> function has been changed to <b>0xea60</b> milliseconds, or <b>60</b> seconds. If internet connectivity is maintained, 1,440 iterations means the program will run for roughly 24 hours:<br>
<img src="/images/lab6/sleep.png">
</p>
</div>
<br>
<br>
<div>
<h2>Conclusion</h2>
<p>
Although I was already familiar with the idea of recognizing high-level programming constructs in assembly, these labs went into much more detail (especially breaking down the <b>for</b> loop in the fourth sample). This chapter was good practice for me and would be an excellent introduction to assembly and calling conventions for someone new.
</p>
</div>